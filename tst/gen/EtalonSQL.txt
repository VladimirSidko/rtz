SELECT
  M.ID,
  M.ID AS ID_DRUG,
  M.ID_MEDICAMENT,
  M.ID_MORION,
  M.ID_NAME_INN,
  M.ID_NAME_REG,
  M.ID_NAME_SUB,
  M.ID_FORM_REG,
  M.ID_FORM_SUB,
  M.ID_CATEGORY,
  M.ID_NODE_ATC,
  M.ID_NODE_NFC,
  M.ID_UNIT,
  M.ID_OWNER,
  M.ID_MAKER,
  M.ID_ISSUE,
  M.ID_GROUP,
  M.ID_VAT,
  M.ID_SYNONYM,

  /* M_DRUG FRAME */
  M.NAME,
  M.NAME_EXT AS DRUG,
  NI.NAME_RUS AS NAME_INN,
  M.NAME_REG,
  M.FORM,
  M.FORM_REG,
  M.CATEGORY,
  (
    SELECT FIRST 1
      C.CODE||' '||C.NAME_RUS
    FROM M_CLASS C
      JOIN M_CLASS_DRUG CD1 ON
        CD1.ID_CLASS = C.ID AND
        CD1.ID_DRUG = M.ID
    WHERE
      -- ATC классификация
      C.NODE_CODE STARTING WITH '0001'
  ) AS NODE_ATC,
  --NA.NAME AS NODE_ATC,
  (
    SELECT FIRST 1
      C.CODE||' '||C.NAME_RUS
    FROM M_CLASS C
      JOIN M_CLASS_DRUG CD1 ON
        CD1.ID_CLASS = C.ID AND
        CD1.ID_DRUG = M.ID
    WHERE
      -- NFC классификация
      C.NODE_CODE STARTING WITH '0006'
  ) AS NODE_NFC,
  --NN.NAME AS NODE_NFC,
  M.NUMBER,
  M.OWNER,
  M.MAKER,
  U.NAME AS UNIT,
  M.PRESCRIBED,
  M.ORDER_333,
  M.REG_ISSUE,
  M.REG_START,
  M.REG_CLOSE,
  M.ID_MORION||'' AS CODE_M,
  M.BARCODE,
  I.NAME AS ISSUE,
  G.NAME AS GROUP_NAME,
  V.VAL AS VAT,
  M.DIVISOR,
  M.IS_FAVORITE,
  M.IS_BUDGET,
  IIF((M.ID_INFO > 0) OR EXISTS(SELECT 1 FROM M_INFO_GFC_DRUG G WHERE G.ID_DRUG = M.ID), 1, 0) AS HAS_INFO_AND_GFC,
  IIF(NI.ID_INFO <> 0, 1, 0) AS HAS_INFO_INN,
  M.USER_NOTE,
  M.USER_NAME,
  M.USER_TIME
FROM M_DRUG M
  LEFT JOIN M_NAME_INN NI ON NI.ID = M.ID_NAME_INN
  --LEFT JOIN M_NODE_ATC NA ON NA.ID = M.ID_NODE_ATC
  --LEFT JOIN M_NODE_NFC NN ON NN.ID = M.ID_NODE_NFC
  LEFT JOIN M_UNIT U      ON U.ID = M.ID_UNIT
  LEFT JOIN M_ISSUE I     ON I.ID = M.ID_ISSUE
  LEFT JOIN M_GROUP G     ON G.ID = M.ID_GROUP
  LEFT JOIN C_VAT V       ON V.ID = M.ID_VAT
WHERE
  (M.IS_FAVORITE = :FILTER_DRUG OR :FILTER_DRUG IS NULL)
ORDER BY
  UPPER(M.NAME_EXT)
